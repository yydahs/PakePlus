<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多项目记账工具</title>
    
    <!-- Element Plus CSS -->
    <link href="./static/index.css" rel="stylesheet">
    
    <!-- Vue 3 -->
    <script src="./static/vue.global.js"></script>
    
    <!-- Element Plus JS -->
    <script src="./static/index.full.js"></script>
    
    <!-- Element Plus 中文语言包 -->
    <script src="./static/zh-cn.min.js"></script>
    
    <!-- Excel导出库 -->
    <script src="./static/xlsx.full.min.js"></script>
    
    <!-- 日期处理库 -->
    <script src="./static/dayjs.min.js"></script>
    
    <!-- 图表库 -->
    <script src="./static/chart.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .project-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .income { color: #27AE60; }
        .expense { color: #E74C3C; }
        .balance { color: #3498DB; }
        .count { color: #9B59B6; }
        
        .filters {
            display: grid;
            /* grid-template-columns: 150px 150px auto 230px 150px 150px; */
            /* 搜索栏宽度 */
            grid-template-columns: auto auto auto auto auto auto;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            align-items: center;
        }
        
        .table-container {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }
        
        .chart-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 页面头部 -->
            <div class="header">
                <h1>💰 记账工具</h1>
                <p>项目化管理您的收支，数据本地存储更安全</p>
            </div>

            <div class="main-content">
                <!-- 项目选择器 -->
                <div class="project-selector">
                    <el-select v-model="currentProject" placeholder="选择项目" style="width: 200px" @change="onProjectChange">
                        <el-option 
                            v-for="project in projects" 
                            :key="project.id" 
                            :label="project.name" 
                            :value="project.id">
                        </el-option>
                    </el-select>
                    <el-button type="primary" @click="showProjectDialog = true">新建项目</el-button>
                    <el-button type="warning" @click="editCurrentProject" :disabled="!currentProject">编辑项目</el-button>
                    <el-button type="danger" @click="deleteCurrentProject" :disabled="!currentProject">删除项目</el-button>
                </div>

                <!-- 当前项目信息 -->
                <div v-if="currentProjectData">
                    <!-- <h3>{{ currentProjectData.name }}</h3>
                    <p style="color: #666; margin-bottom: 20px;">{{ currentProjectData.description }}</p> -->
                    
                    <!-- 统计卡片 -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div>💰 总收入</div>
                            <div class="stat-value income">¥{{ formatMoney(totalIncome) }}</div>
                            <small>{{ incomeCount }}笔收入</small>
                        </div>
                        <div class="stat-card">
                            <div>💸 总支出</div>
                            <div class="stat-value expense">¥{{ formatMoney(totalExpense) }}</div>
                            <small>{{ expenseCount }}笔支出</small>
                        </div>
                        <div class="stat-card">
                            <div>💳 收支差额（收入-支出）</div>
                            <div class="stat-value" :class="{ 'income': balance >= 0, 'expense': balance < 0 }">
                                {{ balance >= 0 ? '+' : '-' }}¥{{ formatMoney(Math.abs(balance)) }}
                            </div>
                            <small>{{ balance >= 0 ? '盈余' : '赤字' }}</small>
                        </div>
                        <div class="stat-card">
                            <div>📊 记录总数</div>
                            <div class="stat-value count">{{ totalRecords }}</div>
                            <small>笔财务记录</small>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div style="margin-bottom: 20px;">
                        <el-button type="primary" @click="showRecordDialog = true">新增记录</el-button>
                        <el-button type="success" @click="showTypeDialog = true">管理类型</el-button>
                        <el-button type="info" @click="exportData">导出Excel</el-button>
                        <el-button type="warning" @click="showImportDialog = true" :disabled="!canImport">导入Excel</el-button>
                    </div>

                    <!-- 筛选器 -->
                    <div class="filters">
                        <el-select v-model="filters.type" placeholder="选择类型" clearable>
                            <el-option label="全部类型" value=""></el-option>
                            <el-option v-for="type in currentProjectTypes" :key="type" :label="type" :value="type"></el-option>
                        </el-select>
                        
                        <el-select v-model="filters.category" placeholder="收支类别" clearable>
                            <el-option label="全部类别" value=""></el-option>
                            <el-option label="收入" value="income"></el-option>
                            <el-option label="支出" value="expense"></el-option>
                        </el-select>
                        
                        <el-date-picker
                            v-model="filters.dateRange"
                            type="daterange"
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            format="YYYY-MM-DD"
                            value-format="YYYY-MM-DD">
                        </el-date-picker>
                        
                        <el-input v-model="filters.keyword" placeholder="搜索备注" clearable></el-input>
                        
                        <el-button type="primary" @click="applyFilters">筛选</el-button>
                        <el-button @click="resetFilters">重置</el-button>
                    </div>

                    <!-- 数据表格 -->
                    <div class="table-container">
                        <el-table :data="paginatedData" style="width: 100%" stripe border>
                            <el-table-column prop="date" label="日期" width="130" sortable>
                                <template #default="{ row }">
                                    {{ formatDate(row.date) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="type" label="类型" width="140">
                                <template #default="{ row }">
                                    <el-tag size="small" :type="getTypeTagColor(row.type)">{{ row.type }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="category" label="类别" width="110">
                                <template #default="{ row }">
                                    <el-tag :type="row.category === 'income' ? 'success' : 'danger'" size="small">
                                        {{ row.category === 'income' ? '收入' : '支出' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="amount" label="金额" width="160" sortable>
                                <template #default="{ row }">
                                    <span :class="{ 'income': row.category === 'income', 'expense': row.category === 'expense' }" style="font-weight: bold;">
                                        {{ row.category === 'income' ? '+' : '-' }}¥{{ formatMoney(row.amount) }}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="remark" label="备注" min-width="150"></el-table-column>
                            <el-table-column prop="ticketLocation" label="票据位置" min-width="120"></el-table-column>
                            <el-table-column label="操作" width="160">
                                <template #default="{ row }">
                                    <el-button type="primary" size="small" @click="editRecord(row)">编辑</el-button>
                                    <el-button type="danger" size="small" @click="deleteRecord(row.id)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- 分页 -->
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <el-pagination
                            v-model:current-page="currentPage"
                            v-model:page-size="pageSize"
                            :page-sizes="[10, 20, 50, 100]"
                            layout="total, sizes, prev, pager, next, jumper"
                            :total="filteredData.length"
                            background>
                        </el-pagination>
                    </div>

                    <!-- 图表分析 -->
                    <div v-if="filteredData.length > 0" class="charts-section">
                        <div class="chart-card">
                            <h4 style="text-align: center; margin-bottom: 20px;">📈 月度收支趋势</h4>
                            <canvas ref="trendChart" style="max-height: 300px;"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <h4 style="text-align: center; margin-bottom: 20px;">🥧 支出类型分布</h4>
                            <canvas ref="categoryChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 无项目提示 -->
                <div v-else style="text-align: center; padding: 60px 20px; color: #666;">
                    <div style="font-size: 4em; margin-bottom: 20px;">📊</div>
                    <h3>欢迎使用多项目记账工具</h3>
                    <p>请先创建一个项目开始记账</p>
                    <el-button type="primary" @click="showProjectDialog = true">创建第一个项目</el-button>
                </div>
            </div>
        </div>

        <!-- 项目对话框 -->
        <el-dialog v-model="showProjectDialog" :title="editingProject ? '编辑项目' : '新建项目'" width="500px">
            <el-form :model="projectForm" label-width="80px">
                <el-form-item label="项目名称" required>
                    <el-input v-model="projectForm.name" placeholder="请输入项目名称"></el-input>
                </el-form-item>
                <el-form-item label="项目描述">
                    <el-input v-model="projectForm.description" type="textarea" placeholder="请输入项目描述"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showProjectDialog = false">取消</el-button>
                <el-button type="primary" @click="saveProject">保存</el-button>
            </template>
        </el-dialog>

        <!-- 记录对话框 -->
        <el-dialog v-model="showRecordDialog" :title="editingRecord ? '编辑记录' : '新增记录'" width="500px">
            <el-form :model="recordForm" label-width="80px">
                <el-form-item label="类型" required>
                    <el-select v-model="recordForm.type" placeholder="选择类型" style="width: 100%">
                        <el-option v-for="type in currentProjectTypes" :key="type" :label="type" :value="type"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="类别" required>
                    <el-radio-group v-model="recordForm.category">
                        <el-radio label="income">收入</el-radio>
                        <el-radio label="expense">支出</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item label="金额" required>
                    <el-input-number v-model="recordForm.amount" :min="0" :precision="2" style="width: 100%"></el-input-number>
                </el-form-item>
                <el-form-item label="日期" required>
                    <el-date-picker v-model="recordForm.date" type="date" format="YYYY-MM-DD" value-format="YYYY-MM-DD" style="width: 100%"></el-date-picker>
                </el-form-item>
                <el-form-item label="备注">
                    <el-input v-model="recordForm.remark" type="textarea" placeholder="请输入备注"></el-input>
                </el-form-item>
                <el-form-item label="票据位置">
                    <el-input v-model="recordForm.ticketLocation" placeholder="请输入票据位置"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showRecordDialog = false">取消</el-button>
                <el-button type="primary" @click="saveRecord">保存</el-button>
            </template>
        </el-dialog>

        <!-- 类型管理对话框 -->
        <el-dialog v-model="showTypeDialog" title="管理类型" width="400px">
            <div style="margin-bottom: 20px;">
                <el-input v-model="newTypeName" placeholder="输入新类型名称" style="width: 250px; margin-right: 10px;"></el-input>
                <el-button type="primary" @click="addType">添加</el-button>
            </div>
            <el-tag v-for="type in currentProjectTypes" :key="type" closable @close="removeType(type)" style="margin: 5px;">
                {{ type }}
            </el-tag>
        </el-dialog>

        <!-- 导入Excel对话框 -->
        <el-dialog v-model="showImportDialog" title="导入Excel数据" width="500px">
            <div style="margin-bottom: 20px;">
                <el-alert 
                    title="导入说明" 
                    type="info" 
                    :closable="false" 
                    style="margin-bottom: 15px;">
                    <template #default>
                        <div>• 只能导入本系统导出的Excel文件</div>
                        <div>• 项目必须没有任何记录才能导入</div>
                        <div>• 导入成功后，此项目将不能再次导入</div>
                        <div>• 支持包含"收入记录"和"支出记录"工作表的文件</div>
                    </template>
                </el-alert>
                
                <el-upload
                    ref="uploadRef"
                    :auto-upload="false"
                    :show-file-list="true"
                    :limit="1"
                    accept=".xlsx,.xls"
                    :on-change="handleFileChange"
                    :before-remove="handleFileRemove">
                    <el-button type="primary">选择Excel文件</el-button>
                    <template #tip>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            只能上传 .xlsx 或 .xls 格式的文件
                        </div>
                    </template>
                </el-upload>
            </div>
            
            <div v-if="importPreviewData.length > 0" style="margin-bottom: 20px;">
                <h4>数据预览（前5条记录）：</h4>
                <el-table :data="importPreviewData.slice(0, 5)" size="small" border>
                    <el-table-column prop="date" label="日期" width="100"></el-table-column>
                    <el-table-column prop="type" label="类型" width="100"></el-table-column>
                    <el-table-column prop="category" label="类别" width="80">
                        <template #default="{ row }">
                            {{ row.category === 'income' ? '收入' : '支出' }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="amount" label="金额" width="100"></el-table-column>
                    <el-table-column prop="remark" label="备注" show-overflow-tooltip></el-table-column>
                </el-table>
                <div style="margin-top: 10px; color: #666; font-size: 14px;">
                    预计导入 {{ totalImportCount }} 条记录
                </div>
            </div>

            <template #footer>
                <el-button @click="cancelImport">取消</el-button>
                <el-button 
                    type="primary" 
                    @click="confirmImport" 
                    :disabled="importPreviewData.length === 0"
                    :loading="importLoading">
                    确认导入
                </el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // IndexedDB 管理类
        class AccountingDB {
            constructor() {
                this.dbName = 'AccountingDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // 项目表
                        if (!db.objectStoreNames.contains('projects')) {
                            const projectStore = db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
                            projectStore.createIndex('name', 'name', { unique: false });
                        }
                        
                        // 记录表
                        if (!db.objectStoreNames.contains('records')) {
                            const recordStore = db.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
                            recordStore.createIndex('projectId', 'projectId', { unique: false });
                            recordStore.createIndex('date', 'date', { unique: false });
                        }
                        
                        // 类型表
                        if (!db.objectStoreNames.contains('types')) {
                            const typeStore = db.createObjectStore('types', { keyPath: 'id', autoIncrement: true });
                            typeStore.createIndex('projectId', 'projectId', { unique: false });
                        }
                    };
                });
            }

            async addProject(project) {
                const transaction = this.db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                return store.add({
                    ...project,
                    createdAt: new Date().toISOString()
                });
            }

            async updateProject(project) {
                const transaction = this.db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                return store.put(project);
            }

            async addRecords(records) {
                const transaction = this.db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                const promises = records.map(record => store.add(record));
                return Promise.all(promises);
            }

            async markProjectAsImported(projectId) {
                const transaction = this.db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                const project = await new Promise((resolve, reject) => {
                    const request = store.get(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                if (project) {
                    project.hasImported = true;
                    project.importedAt = new Date().toISOString();
                    return store.put(project);
                }
            }

            async deleteProject(id) {
                const transaction = this.db.transaction(['projects', 'records', 'types'], 'readwrite');
                
                // 删除项目
                transaction.objectStore('projects').delete(id);
                
                // 删除相关记录
                const recordStore = transaction.objectStore('records');
                const recordIndex = recordStore.index('projectId');
                const recordRequest = recordIndex.openCursor(IDBKeyRange.only(id));
                recordRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    }
                };
                
                // 删除相关类型
                const typeStore = transaction.objectStore('types');
                const typeIndex = typeStore.index('projectId');
                const typeRequest = typeIndex.openCursor(IDBKeyRange.only(id));
                typeRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    }
                };
                
                return transaction.complete;
            }

            async getProjects() {
                const transaction = this.db.transaction(['projects'], 'readonly');
                const store = transaction.objectStore('projects');
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async addRecord(record) {
                const transaction = this.db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                return store.add({
                    ...record,
                    createdAt: new Date().toISOString()
                });
            }

            async updateRecord(record) {
                const transaction = this.db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                return store.put(record);
            }

            async deleteRecord(id) {
                const transaction = this.db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                return store.delete(id);
            }

            async getRecords(projectId) {
                const transaction = this.db.transaction(['records'], 'readonly');
                const store = transaction.objectStore('records');
                const index = store.index('projectId');
                return new Promise((resolve, reject) => {
                    const request = index.getAll(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async addType(type) {
                const transaction = this.db.transaction(['types'], 'readwrite');
                const store = transaction.objectStore('types');
                return store.add(type);
            }

            async deleteType(projectId, typeName) {
                const transaction = this.db.transaction(['types'], 'readwrite');
                const store = transaction.objectStore('types');
                const index = store.index('projectId');
                return new Promise((resolve, reject) => {
                    const request = index.openCursor(IDBKeyRange.only(projectId));
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.name === typeName) {
                                cursor.delete();
                                resolve();
                            } else {
                                cursor.continue();
                            }
                        } else {
                            resolve();
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async getTypes(projectId) {
                const transaction = this.db.transaction(['types'], 'readonly');
                const store = transaction.objectStore('types');
                const index = store.index('projectId');
                return new Promise((resolve, reject) => {
                    const request = index.getAll(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        createApp({
            data() {
                return {
                    db: new AccountingDB(),
                    projects: [],
                    currentProject: null,
                    currentProjectData: null,
                    currentProjectTypes: [],
                    records: [],
                    filteredData: [],
                    currentPage: 1,
                    pageSize: 20,
                    filters: {
                        type: '',
                        category: '',
                        dateRange: null,
                        keyword: ''
                    },
                    showProjectDialog: false,
                    showRecordDialog: false,
                    showTypeDialog: false,
                    showImportDialog: false,
                    editingProject: null,
                    editingRecord: null,
                    projectForm: {
                        name: '',
                        description: ''
                    },
                    recordForm: {
                        type: '',
                        category: 'expense',
                        amount: 0,
                        date: dayjs().format('YYYY-MM-DD'),
                        remark: '',
                        ticketLocation: ''
                    },
                    newTypeName: '',
                    trendChartInstance: null,
                    categoryChartInstance: null,
                    importPreviewData: [],
                    importLoading: false,
                    currentUploadFile: null,
                    totalImportCount: 0
                };
            },
            computed: {
                totalIncome() {
                    return this.filteredData
                        .filter(item => item.category === 'income')
                        .reduce((sum, item) => sum + item.amount, 0);
                },
                totalExpense() {
                    return this.filteredData
                        .filter(item => item.category === 'expense')
                        .reduce((sum, item) => sum + item.amount, 0);
                },
                balance() {
                    return this.totalIncome - this.totalExpense;
                },
                totalRecords() {
                    return this.filteredData.length;
                },
                incomeCount() {
                    return this.filteredData.filter(item => item.category === 'income').length;
                },
                expenseCount() {
                    return this.filteredData.filter(item => item.category === 'expense').length;
                },
                paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredData.slice(start, end);
                },
                canImport() {
                    return this.currentProjectData && 
                           this.records.length === 0 && 
                           !this.currentProjectData.hasImported;
                }
            },
            async mounted() {
                await this.initDB();
                await this.loadProjects();
            },
            methods: {
                async initDB() {
                    try {
                        await this.db.init();
                        console.log('数据库初始化成功');
                    } catch (error) {
                        console.error('数据库初始化失败:', error);
                        ElMessage.error('数据库初始化失败');
                    }
                },
                async loadProjects() {
                    try {
                        this.projects = await this.db.getProjects();
                        if (this.projects.length > 0 && !this.currentProject) {
                            this.currentProject = this.projects[0].id;
                            await this.onProjectChange();
                        }
                    } catch (error) {
                        console.error('加载项目失败:', error);
                        ElMessage.error('加载项目失败');
                    }
                },
                async onProjectChange() {
                    if (!this.currentProject) {
                        this.currentProjectData = null;
                        return;
                    }
                    
                    this.currentProjectData = this.projects.find(p => p.id === this.currentProject);
                    await this.loadRecords();
                    await this.loadTypes();
                    this.resetFilters();
                },
                async loadRecords() {
                    try {
                        this.records = await this.db.getRecords(this.currentProject);
                        // 按日期降序排序（新日期在前）
                        this.records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        this.filteredData = [...this.records];
                        // 使用延迟确保DOM完全渲染
                        setTimeout(() => {
                            this.generateCharts();
                        }, 100);
                    } catch (error) {
                        console.error('加载记录失败:', error);
                        ElMessage.error('加载记录失败');
                    }
                },
                async loadTypes() {
                    try {
                        const types = await this.db.getTypes(this.currentProject);
                        this.currentProjectTypes = types.map(t => t.name);
                        
                        // 如果没有类型，添加默认类型
                        if (this.currentProjectTypes.length === 0) {
                            const defaultTypes = ['零星杂项', '砌砖工资', '二构工资', '土方机械', '塔吊租赁', '钢管租赁', '砼工资', '钢筋工资'];
                            for (const typeName of defaultTypes) {
                                await this.db.addType({
                                    projectId: this.currentProject,
                                    name: typeName
                                });
                            }
                            await this.loadTypes();
                        }
                    } catch (error) {
                        console.error('加载类型失败:', error);
                        ElMessage.error('加载类型失败');
                    }
                },
                async saveProject() {
                    if (!this.projectForm.name.trim()) {
                        ElMessage.warning('请输入项目名称');
                        return;
                    }
                    
                    try {
                        if (this.editingProject) {
                            await this.db.updateProject({
                                ...this.editingProject,
                                ...this.projectForm
                            });
                            ElMessage.success('项目更新成功');
                        } else {
                            await this.db.addProject(this.projectForm);
                            ElMessage.success('项目创建成功');
                        }
                        
                        this.showProjectDialog = false;
                        this.editingProject = null;
                        this.projectForm = { name: '', description: '' };
                        await this.loadProjects();
                    } catch (error) {
                        console.error('保存项目失败:', error);
                        ElMessage.error('保存项目失败');
                    }
                },
                editCurrentProject() {
                    if (!this.currentProjectData) return;
                    
                    this.editingProject = this.currentProjectData;
                    this.projectForm = {
                        name: this.currentProjectData.name,
                        description: this.currentProjectData.description || ''
                    };
                    this.showProjectDialog = true;
                },
                async deleteCurrentProject() {
                    if (!this.currentProject) return;
                    
                    try {
                        await ElMessageBox.confirm('确定删除当前项目吗？这将删除项目下的所有记录！', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await this.db.deleteProject(this.currentProject);
                        ElMessage.success('项目删除成功');
                        
                        this.currentProject = null;
                        this.currentProjectData = null;
                        await this.loadProjects();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除项目失败:', error);
                            ElMessage.error('删除项目失败');
                        }
                    }
                },
                async saveRecord() {
                    if (!this.recordForm.type || !this.recordForm.amount || !this.recordForm.date) {
                        ElMessage.warning('请填写完整信息');
                        return;
                    }
                    
                    try {
                        const recordData = {
                            ...this.recordForm,
                            projectId: this.currentProject
                        };
                        
                        if (this.editingRecord) {
                            // 编辑记录时需要确认
                            const confirmText = `确认修改记录吗？`;
                            
                            await ElMessageBox.confirm(confirmText, '确认修改记录', {
                                confirmButtonText: '确认修改',
                                cancelButtonText: '取消',
                                type: 'info',
                                dangerouslyUseHTMLString: false
                            });
                            
                            await this.db.updateRecord({
                                ...this.editingRecord,
                                ...recordData
                            });
                            ElMessage.success('记录更新成功');
                        } else {
                            // 新增记录直接保存
                            await this.db.addRecord(recordData);
                            ElMessage.success('记录添加成功');
                        }
                        
                        this.showRecordDialog = false;
                        this.editingRecord = null;
                        this.recordForm = {
                            type: '',
                            category: 'expense',
                            amount: 0,
                            date: dayjs().format('YYYY-MM-DD'),
                            remark: '',
                            ticketLocation: ''
                        };
                        await this.loadRecords();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('保存记录失败:', error);
                            ElMessage.error('保存记录失败');
                        }
                    }
                },
                editRecord(record) {
                    this.editingRecord = record;
                    this.recordForm = {
                        type: record.type,
                        category: record.category,
                        amount: record.amount,
                        date: record.date,
                        remark: record.remark || '',
                        ticketLocation: record.ticketLocation || ''
                    };
                    this.showRecordDialog = true;
                },
                async deleteRecord(id) {
                    try {
                        await ElMessageBox.confirm('确定删除这条记录吗？', '确认', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await this.db.deleteRecord(id);
                        ElMessage.success('记录删除成功');
                        await this.loadRecords();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除记录失败:', error);
                            ElMessage.error('删除记录失败');
                        }
                    }
                },
                async addType() {
                    if (!this.newTypeName.trim()) {
                        ElMessage.warning('请输入类型名称');
                        return;
                    }
                    
                    if (this.currentProjectTypes.includes(this.newTypeName)) {
                        ElMessage.warning('类型已存在');
                        return;
                    }
                    
                    try {
                        await this.db.addType({
                            projectId: this.currentProject,
                            name: this.newTypeName
                        });
                        
                        this.newTypeName = '';
                        await this.loadTypes();
                        ElMessage.success('类型添加成功');
                    } catch (error) {
                        console.error('添加类型失败:', error);
                        ElMessage.error('添加类型失败');
                    }
                },
                async removeType(typeName) {
                    try {
                        // 检查是否有记录使用了此类型
                        const recordsUsingType = this.records.filter(record => record.type === typeName);
                        
                        if (recordsUsingType.length > 0) {
                            ElMessage.warning(`无法删除类型"${typeName}"，当前有 ${recordsUsingType.length} 条记录正在使用此类型。请先删除或修改相关记录。`);
                            return;
                        }
                        
                        // 确认删除
                        await ElMessageBox.confirm(`确定删除类型"${typeName}"吗？`, '确认删除', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await this.db.deleteType(this.currentProject, typeName);
                        await this.loadTypes();
                        ElMessage.success('类型删除成功');
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除类型失败:', error);
                            ElMessage.error('删除类型失败');
                        }
                    }
                },
                applyFilters() {
                    this.filteredData = this.records.filter(item => {
                        // 类型筛选
                        if (this.filters.type && item.type !== this.filters.type) {
                            return false;
                        }
                        
                        // 类别筛选
                        if (this.filters.category && item.category !== this.filters.category) {
                            return false;
                        }
                        
                        // 日期范围筛选
                        if (this.filters.dateRange && this.filters.dateRange.length === 2) {
                            if (item.date < this.filters.dateRange[0] || item.date > this.filters.dateRange[1]) {
                                return false;
                            }
                        }
                        
                        // 关键词搜索
                        if (this.filters.keyword) {
                            const keyword = this.filters.keyword.toLowerCase();
                            const remark = (item.remark || '').toLowerCase();
                            if (!remark.includes(keyword)) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    // 筛选后也按日期降序排序
                    this.filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    this.currentPage = 1;
                    // 使用延迟确保DOM完全渲染
                    setTimeout(() => {
                        this.generateCharts();
                    }, 100);
                },
                resetFilters() {
                    this.filters = {
                        type: '',
                        category: '',
                        dateRange: null,
                        keyword: ''
                    };
                    this.filteredData = [...this.records];
                    // 重置筛选后也按日期降序排序
                    this.filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    this.currentPage = 1;
                    
                    // 先销毁现有图表，再重新创建
                    if (this.trendChartInstance) {
                        try {
                            this.trendChartInstance.destroy();
                        } catch (error) {
                            console.warn('重置时销毁趋势图表失败:', error);
                        }
                        this.trendChartInstance = null;
                    }
                    
                    if (this.categoryChartInstance) {
                        try {
                            this.categoryChartInstance.destroy();
                        } catch (error) {
                            console.warn('重置时销毁分类图表失败:', error);
                        }
                        this.categoryChartInstance = null;
                    }
                    
                    // 使用延迟确保DOM完全渲染和图表完全销毁
                    setTimeout(() => {
                        this.generateCharts();
                    }, 150);
                },
                exportData() {
                    if (this.filteredData.length === 0) {
                        ElMessage.warning('没有数据可导出');
                        return;
                    }
                    
                    // 分离收入和支出数据
                    const incomeData = this.filteredData
                        .filter(item => item.category === 'income')
                        .map(item => ({
                            '日期': item.date,
                            '类型': item.type,
                            '金额': item.amount,
                            '备注': item.remark || '',
                            '票据位置': item.ticketLocation || ''
                        }));
                    
                    const expenseData = this.filteredData
                        .filter(item => item.category === 'expense')
                        .map(item => ({
                            '日期': item.date,
                            '类型': item.type,
                            '金额': item.amount,
                            '备注': item.remark || '',
                            '票据位置': item.ticketLocation || ''
                        }));
                    
                    // 创建工作簿
                    const workbook = XLSX.utils.book_new();
                    
                    // 创建收入工作表
                    if (incomeData.length > 0) {
                        const incomeWorksheet = XLSX.utils.json_to_sheet(incomeData);
                        XLSX.utils.book_append_sheet(workbook, incomeWorksheet, '收入记录');
                    }
                    
                    // 创建支出工作表
                    if (expenseData.length > 0) {
                        const expenseWorksheet = XLSX.utils.json_to_sheet(expenseData);
                        XLSX.utils.book_append_sheet(workbook, expenseWorksheet, '支出记录');
                    }
                    
                    // 如果没有任何数据
                    if (incomeData.length === 0 && expenseData.length === 0) {
                        ElMessage.warning('没有数据可导出');
                        return;
                    }
                    
                    const fileName = `${this.currentProjectData.name}_记账数据_${dayjs().format('YYYY-MM-DD')}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                    
                    let message = '数据导出成功！';
                    if (incomeData.length > 0 && expenseData.length > 0) {
                        message += `（收入记录${incomeData.length}条，支出记录${expenseData.length}条）`;
                    } else if (incomeData.length > 0) {
                        message += `（收入记录${incomeData.length}条）`;
                    } else {
                        message += `（支出记录${expenseData.length}条）`;
                    }
                    
                    ElMessage.success(message);
                },
                formatMoney(amount) {
                    return new Intl.NumberFormat('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(amount);
                },
                formatDate(date) {
                    return dayjs(date).format('YYYY-MM-DD');
                },
                getTypeTagColor(type) {
                    const colors = ['', 'success', 'info', 'warning', 'danger'];
                    const hash = type.split('').reduce((a, b) => {
                        a = ((a << 5) - a) + b.charCodeAt(0);
                        return a & a;
                    }, 0);
                    return colors[Math.abs(hash) % colors.length];
                },
                generateCharts() {
                    // 确保canvas元素存在且可见
                    if (!this.$refs.trendChart || !this.$refs.categoryChart) {
                        return;
                    }
                    
                    // 确保之前的图表实例完全清理
                    if (this.trendChartInstance) {
                        try {
                            this.trendChartInstance.destroy();
                        } catch (error) {
                            console.warn('清理趋势图表实例失败:', error);
                        }
                        this.trendChartInstance = null;
                    }
                    
                    if (this.categoryChartInstance) {
                        try {
                            this.categoryChartInstance.destroy();
                        } catch (error) {
                            console.warn('清理分类图表实例失败:', error);
                        }
                        this.categoryChartInstance = null;
                    }
                    
                    // 小延迟确保销毁完成
                    setTimeout(() => {
                        this.generateTrendChart();
                        this.generateCategoryChart();
                    }, 50);
                },
                generateTrendChart() {
                    if (!this.$refs.trendChart || this.filteredData.length === 0) return;
                    
                    // 安全销毁之前的图表实例
                    if (this.trendChartInstance) {
                        try {
                            this.trendChartInstance.destroy();
                        } catch (error) {
                            console.warn('销毁趋势图表失败:', error);
                        }
                        this.trendChartInstance = null;
                    }
                    
                    const ctx = this.$refs.trendChart.getContext('2d');
                    
                    // 按月统计数据
                    const monthlyData = {};
                    this.filteredData.forEach(item => {
                        const month = dayjs(item.date).format('YYYY-MM');
                        if (!monthlyData[month]) {
                            monthlyData[month] = { income: 0, expense: 0 };
                        }
                        if (item.category === 'income') {
                            monthlyData[month].income += item.amount;
                        } else {
                            monthlyData[month].expense += item.amount;
                        }
                    });
                    
                    const labels = Object.keys(monthlyData).sort();
                    const incomeData = labels.map(month => monthlyData[month].income);
                    const expenseData = labels.map(month => monthlyData[month].expense);
                    
                    this.trendChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '收入',
                                data: incomeData,
                                borderColor: '#27AE60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: '支出',
                                data: expenseData,
                                borderColor: '#E74C3C',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                generateCategoryChart() {
                    if (!this.$refs.categoryChart || this.filteredData.length === 0) return;
                    
                    // 安全销毁之前的图表实例
                    if (this.categoryChartInstance) {
                        try {
                            this.categoryChartInstance.destroy();
                        } catch (error) {
                            console.warn('销毁分类图表失败:', error);
                        }
                        this.categoryChartInstance = null;
                    }
                    
                    const ctx = this.$refs.categoryChart.getContext('2d');
                    
                    // 统计支出类型
                    const typeData = {};
                    this.filteredData.filter(item => item.category === 'expense').forEach(item => {
                        typeData[item.type] = (typeData[item.type] || 0) + item.amount;
                    });
                    
                    const labels = Object.keys(typeData);
                    const data = Object.values(typeData);
                    const colors = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                    ];
                    
                    if (labels.length === 0) {
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#999';
                        ctx.textAlign = 'center';
                        ctx.fillText('暂无支出数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                        return;
                    }
                    
                    this.categoryChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors.slice(0, labels.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },
                async handleFileChange(file) {
                    if (file) {
                        this.importPreviewData = []; // 清空预览数据
                        this.importLoading = true;
                        this.currentUploadFile = file; // 保存文件引用
                        try {
                            const workbook = XLSX.read(await file.raw.arrayBuffer(), { type: 'array' });
                            
                            // 检查是否包含"收入记录"和"支出记录"工作表
                            const incomeSheet = workbook.Sheets['收入记录'];
                            const expenseSheet = workbook.Sheets['支出记录'];

                            if (!incomeSheet && !expenseSheet) {
                                ElMessage.error('Excel文件中未找到"收入记录"或"支出记录"工作表！');
                                this.importLoading = false;
                                this.totalImportCount = 0;
                                return;
                            }

                            // 检查项目是否已有记录
                            const existingRecords = await this.db.getRecords(this.currentProject);
                            if (existingRecords.length > 0) {
                                ElMessage.warning('当前项目已有记录，无法导入！请先清空项目记录。');
                                this.importLoading = false;
                                this.totalImportCount = 0;
                                return;
                            }

                            // 检查项目是否已导入过
                            if (this.currentProjectData.hasImported) {
                                ElMessage.warning('此项目已经导入过数据，不能重复导入！');
                                this.importLoading = false;
                                this.totalImportCount = 0;
                                return;
                            }

                            // 解析收入和支出数据
                            let allData = [];
                            
                            if (incomeSheet) {
                                const incomeData = XLSX.utils.sheet_to_json(incomeSheet);
                                const processedIncomeData = incomeData.map(item => ({
                                    date: item['日期'],
                                    type: item['类型'],
                                    category: 'income',
                                    amount: parseFloat(item['金额']),
                                    remark: item['备注'] || '',
                                    ticketLocation: item['票据位置'] || ''
                                }));
                                allData = allData.concat(processedIncomeData);
                            }
                            
                            if (expenseSheet) {
                                const expenseData = XLSX.utils.sheet_to_json(expenseSheet);
                                const processedExpenseData = expenseData.map(item => ({
                                    date: item['日期'],
                                    type: item['类型'], 
                                    category: 'expense',
                                    amount: parseFloat(item['金额']),
                                    remark: item['备注'] || '',
                                    ticketLocation: item['票据位置'] || ''
                                }));
                                allData = allData.concat(processedExpenseData);
                            }

                            // 验证数据格式
                            const validData = allData.filter(item => {
                                return item.date && item.type && item.amount && !isNaN(item.amount);
                            });

                            if (validData.length === 0) {
                                ElMessage.error('未找到有效的记录数据！');
                                this.importLoading = false;
                                this.totalImportCount = 0;
                                return;
                            }

                            // 预览数据
                            this.importPreviewData = validData.slice(0, 10); // 预览前10条记录
                            this.totalImportCount = validData.length; // 保存总记录数
                            ElMessage.success(`文件解析成功，找到 ${validData.length} 条有效记录。`);
                        } catch (error) {
                            console.error('导入Excel失败:', error);
                            ElMessage.error('导入Excel失败，请检查文件格式或内容！');
                            this.totalImportCount = 0;
                        } finally {
                            this.importLoading = false;
                        }
                    }
                },
                handleFileRemove() {
                    this.importPreviewData = [];
                    this.currentUploadFile = null;
                    this.totalImportCount = 0;
                    ElMessage.info('已移除Excel文件');
                },
                cancelImport() {
                    this.showImportDialog = false;
                    this.importPreviewData = [];
                    this.currentUploadFile = null;
                    this.totalImportCount = 0;
                    if (this.$refs.uploadRef) {
                        this.$refs.uploadRef.clearFiles();
                    }
                },
                async confirmImport() {
                    if (this.importPreviewData.length === 0) {
                        ElMessage.warning('请先选择文件并预览数据！');
                        return;
                    }

                    try {
                        await ElMessageBox.confirm('确定要导入这些数据吗？导入后此项目将不能再次导入。', '确认导入', {
                            confirmButtonText: '确定导入',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        this.importLoading = true;
                        if (!this.currentUploadFile) {
                            ElMessage.error('请先选择文件！');
                            this.importLoading = false;
                            return;
                        }

                        const workbook = XLSX.read(await this.currentUploadFile.raw.arrayBuffer(), { type: 'array' });
                        
                        // 检查是否包含"收入记录"和"支出记录"工作表
                        const incomeSheet = workbook.Sheets['收入记录'];
                        const expenseSheet = workbook.Sheets['支出记录'];

                        if (!incomeSheet && !expenseSheet) {
                            ElMessage.error('Excel文件中未找到"收入记录"或"支出记录"工作表！');
                            this.importLoading = false;
                            return;
                        }

                        // 再次检查项目状态
                        const existingRecords = await this.db.getRecords(this.currentProject);
                        if (existingRecords.length > 0) {
                            ElMessage.warning('当前项目已有记录，无法导入！');
                            this.importLoading = false;
                            return;
                        }

                        if (this.currentProjectData.hasImported) {
                            ElMessage.warning('此项目已经导入过数据，不能重复导入！');
                            this.importLoading = false;
                            return;
                        }

                        // 解析并处理数据
                        let allData = [];
                        let typeSet = new Set();

                        if (incomeSheet) {
                            const incomeData = XLSX.utils.sheet_to_json(incomeSheet);
                            const processedIncomeData = incomeData.map(item => ({
                                date: item['日期'],
                                type: item['类型'],
                                category: 'income',
                                amount: parseFloat(item['金额']),
                                remark: item['备注'] || '',
                                ticketLocation: item['票据位置'] || '',
                                projectId: this.currentProject,
                                createdAt: new Date().toISOString()
                            }));
                            allData = allData.concat(processedIncomeData);
                            processedIncomeData.forEach(item => typeSet.add(item.type));
                        }
                        
                        if (expenseSheet) {
                            const expenseData = XLSX.utils.sheet_to_json(expenseSheet);
                            const processedExpenseData = expenseData.map(item => ({
                                date: item['日期'],
                                type: item['类型'], 
                                category: 'expense',
                                amount: parseFloat(item['金额']),
                                remark: item['备注'] || '',
                                ticketLocation: item['票据位置'] || '',
                                projectId: this.currentProject,
                                createdAt: new Date().toISOString()
                            }));
                            allData = allData.concat(processedExpenseData);
                            processedExpenseData.forEach(item => typeSet.add(item.type));
                        }

                        // 验证数据格式
                        const validData = allData.filter(item => {
                            return item.date && item.type && item.amount && !isNaN(item.amount);
                        });

                        if (validData.length === 0) {
                            ElMessage.error('未找到有效的记录数据！');
                            this.importLoading = false;
                            return;
                        }

                        // 添加新的类型到项目中
                        for (const typeName of typeSet) {
                            if (!this.currentProjectTypes.includes(typeName)) {
                                await this.db.addType({
                                    projectId: this.currentProject,
                                    name: typeName
                                });
                            }
                        }

                        // 批量添加记录
                        await this.db.addRecords(validData);
                        
                        // 标记项目为已导入
                        await this.db.markProjectAsImported(this.currentProject);
                        
                        ElMessage.success(`成功导入 ${validData.length} 条记录！`);
                        this.showImportDialog = false;
                        this.importPreviewData = [];
                        this.currentUploadFile = null;
                        this.totalImportCount = 0;
                        if (this.$refs.uploadRef) {
                            this.$refs.uploadRef.clearFiles();
                        }
                        
                        // 重新加载项目和记录数据
                        await this.loadProjects();
                        await this.onProjectChange();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('导入Excel失败:', error);
                            ElMessage.error('导入Excel失败，请检查文件格式或内容！');
                        }
                    } finally {
                        this.importLoading = false;
                    }
                }
            }
        }).use(ElementPlus, {
            locale: ElementPlusLocaleZhCn,
        }).mount('#app');
    </script>
</body>
</html> 